!function(a,b,c,d){"use strict";function e(a){return a.join(" OR ")}function f(a){return a.join(",")}function g(a){return a=a.replace(/(.*?)((?: (?:OR|AND) )|$)/g,function(a,b,c){return 0===b.length||b.match(/:[\(\[].*?[\)\]]/)||(b="entext:("+b+")"),b+c})}function h(a,b){var c,d,e,f,g;for(d=0;d<a.length;d+=1)for(c=a[d],f=0;f<b.length;f+=1)e=b[f],g=c[e],c[e]=g||"","name"===e?c[e]='<a target="_blank" href="http://ndmckanq1.stcpaz.statcan.gc.ca/zj/dataset/'+g+'">'+g+'</a><br><a target="_blank" href="http://ndmckanq1.stcpaz.statcan.gc.ca/zj/dataset/edit/'+g+'#field-extras-1-key" class="btn btn-default"><span class="glyphicon glyphicon-pencil"><span class="wb-inv">Edit '+g+"</span></a>":"object"==typeof g&&(c[e]=g.join(","));return a}function i(a){var b,c=[];for(b=0;b<a.length;b+=1)c.push({data:a[b],title:a[b]});return c}var j=b.module("reportGenerator",["organizations","advanced-search","display-fields"]),k=d("#results");j.run(["$http","$rootScope",function(a,b){b.maxResultsOptions={20:20,50:50,100:100,1e3:"1000 (default)",2e3:2e3},b.maxResults="1000",b.sendQuery=function(){var c="http://ndmckanq1.stcpaz.statcan.gc.ca/so04/select",j={wt:"json","json.wrf":"JSON_CALLBACK",otherparams:"",fq:"zckownerorg_bi_strs:"+e(b.orgCtrl.selectedOrganizations),q:g(b.query),fl:f(b.dspFieldCtrl.fields),rows:parseInt(b.maxResults,10)};a.jsonp(c,{params:j}).then(function(a){b.queryResults=a.data.response,b.downloadLink=a.config.url+"?"+d.param(d.extend({},a.config.params,{wt:"csv"}));var c=a.data.responseHeader.params.fl.split(","),e={data:h(b.queryResults.docs,c),columns:i(c),pageLength:100,lengthMenu:[[50,100,200,500,-1],[50,100,200,500,"All"]]};k.DataTable().destroy(),k.empty().removeClass("wb-tables-inited wb-init").attr("data-wb-tables",JSON.stringify(e)).trigger("wb-init.wb-tables")})}}])}(window,window.angular,window.wb,jQuery),angular.module("checklist-model",[]).directive("checklistModel",["$parse","$compile",function(a,b){function c(a,b,c){if(angular.isArray(a))for(var d=a.length;d--;)if(c(a[d],b))return!0;return!1}function d(a,b,d){return a=angular.isArray(a)?a:[],c(a,b,d)||a.push(b),a}function e(a,b,c){if(angular.isArray(a))for(var d=a.length;d--;)if(c(a[d],b)){a.splice(d,1);break}return a}function f(f,g,h){function i(a,b){f.checked=c(a,m,n)}b(g)(f);var j=a(h.checklistModel),k=j.assign,l=a(h.checklistChange),m=a(h.checklistValue)(f.$parent),n=angular.equals;h.hasOwnProperty("checklistComparator")&&(n=a(h.checklistComparator)(f.$parent)),f.$watch("checked",function(a,b){if(a!==b){var c=j(f.$parent);a===!0?k(f.$parent,d(c,m,n)):k(f.$parent,e(c,m,n)),l&&l(f)}}),angular.isFunction(f.$parent.$watchCollection)?f.$parent.$watchCollection(h.checklistModel,i):f.$parent.$watch(h.checklistModel,i,!0)}return{restrict:"A",priority:1e3,terminal:!0,scope:!0,compile:function(a,b){if("INPUT"!==a[0].tagName||"checkbox"!==b.type)throw'checklist-model should be applied to `input[type="checkbox"]`.';if(!b.checklistValue)throw"You should provide `checklist-value`.";return a.removeAttr("checklist-model"),a.attr("ng-model","checked"),f}}}]),function(a,b){"use strict";var c=b.module("advanced-search",["fields"]);c.controller("AdvancedSearchController",["$rootScope",function(a){this.emptyKey=!1,this.operator="AND",this.keyword="",this.addField=function(){var b,c="";this.field&&(this.keyword||this.emptyKey)&&(b=this.emptyKey?"-"+this.field+':["" TO *]':this.field+":(*"+this.keyword+"*)",a.query&&""!==a.query.trim()&&(c=" "+(this.emptyKey?"AND":this.operator)+" "),a.query=(a.query||"")+c+b,this.keyword="",this.field="")}}]),c.directive("advancedSearch",function(){return{restrict:"E",templateUrl:"templates/advanced-search.html",controller:"AdvancedSearchController",controllerAs:"advSrchCtrl"}}),String.prototype.trim||!function(){var a=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;String.prototype.trim=function(){return this.replace(a,"")}}()}(window,window.angular),function(a,b){"use strict";var c=b.module("display-fields",["fields"]);c.controller("DisplayFieldsController",["$rootScope",function(a){this.field="",this.fields=["name","extras_conttype_en_txtm","extras_title_en_txts","extras_subjnew_en_txtm","extras_pkuniqueidcode_bi_strs","extras_zckstatus_bi_txtm"],this.mandatoryFields=["name"],this.getVisible=function(){return 0!==this.fields.length},this.getMandatory=function(a){return-1!==this.mandatoryFields.indexOf(a)},this.addField=function(){this.field&&-1===this.fields.indexOf(this.field)&&(this.fields.push(this.field),this.field="")},this.removeField=function(a){this.fields.splice(this.fields.indexOf(a),1)}}]),c.directive("displayFields",function(){return{restrict:"E",templateUrl:"templates/display-fields.html",controller:"DisplayFieldsController",controllerAs:"dspFieldCtrl"}})}(window,window.angular),function(a,b){"use strict";var c=b.module("fields",[]);c.controller("FieldsController",["$http","$q","$rootScope",function(a,b,c){var d=this;this.organizationFields={},this.fields=[],c.$on("organization.selected",function(c,e){var f,g,h,i="http://ndmckanq1.stcpaz.statcan.gc.ca/so04/select?q=*&rows=1&fl=extras_*,name&wt=json&json.wrf=JSON_CALLBACK&fq=extras_zckownerorg_bi_strs:",j=function(a){var b=a.responseHeader.params.fq,c=b.substr(b.indexOf(":")+1);d.organizationFields[c]=Object.keys(a.response.docs[0]),l=l.concat(d.organizationFields[c])},k=[],l=[];for(f=0;f<e.length;f+=1)g=e[f],d.organizationFields[g]?l=l.concat(d.organizationFields[g]):(h=a.jsonp(i+g,{cache:!0}),h.success(j),k.push(h));b.all(k).then(function(){d.fields=[],l.forEach(function(a,b,c){-1===d.fields.indexOf(a)&&d.fields.push(a)}),d.fields.sort()})})}])}(window,window.angular),function(a,b){"use strict";var c=b.module("organizations",["checklist-model"]);c.controller("OrganizationsController",["$http","$rootScope",function(a,b){var c="http://ndmckanq1.stcpaz.statcan.gc.ca/zj/api/3/action/organization_list?callback=JSON_CALLBACK",d=this;this.changed=function(){b.$emit("organization.selected",this.selectedOrganizations)},a.jsonp(c).then(function(a){d.organizations=a.data.result,d.selectedOrganizations=["maformat","maimdb","maprimary"],d.changed()})}]),c.directive("organizations",function(){return{restrict:"E",templateUrl:"templates/organizations.html",controller:"OrganizationsController",controllerAs:"orgCtrl"}})}(window,window.angular);